---
title: "Trabalho1-MCCDII"
author: "Emanuelle Oliveira"
date: "2025-10-02"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(nortest)
library(tseries)
library(gt)     
library(scales) 
library(stats)
set.seed(89)
```

# Geração de Amostras

## Método da Rejeição Qui-Quadrado

```{r rejection_chi_squared}
# Gráfico para verificação

chi_rejection <- function(n){
  x <- numeric(n)
  i <- 0
  
  while(i < n){
    y_candidato <- rexp(1, rate=1/4)
    U <- runif(1, 0, 1)
    
    if(U <= exp(-y_candidato/4)){
      i <- i + 1
      x[i] <- y_candidato
    }
  }
  return(x)
}
```


```{r graphic_chi_squared}
# set.seed(42)
amostra <- chi_rejection(10000)

# Histograma no mesmo estilo visual
hist(amostra, 
     prob = TRUE, 
     breaks = "FD",
     main = "Amostra Gerada vs. Densidade Teórica",
     xlab = "Valores da Amostra",
     ylab = "Densidade",
     col = "lightblue",
     border = "gray40",
     xlim = c(0, 8),
     ylim = c(0, max(density(amostra)$y) * 1.2))

# Densidade teórica da Qui-Quadrado(2)
curve(dchisq(x, df = 2), 
      from = 0, to = max(amostra),
      add = TRUE, 
      col = "red", 
      lwd = 2)

# Legenda padronizada
legend("topright", 
       legend = c("Histograma da Amostra", "Densidade Teórica (Chi²(2))"),
       pch = c(22, NA),
       pt.bg = c("lightblue", NA),
       col = c("gray40", "red"),
       lty = c(NA, 1),
       lwd = c(NA, 2),
       pt.cex = 1.6,
       bty = "n",
       cex = 0.9)

# Subtítulo padronizado
mtext("Método da Rejeição com proposta Exponencial(1/4)", 
      side = 1, line = 4, cex = 0.9, font = 3)
```

## Método da Transforma Inversa Pareto
```{r icdf_pareto}
pareto_icdf <- function(n, a, b){
  U <- runif(n, 0, 1)
  x <- b * (U^(-1/a))
  return(x) 
}
```


```{r graphic_pareto}
# Gráfico para verificação

a <- 2    # parâmetro de forma
b <- 1    # parâmetro de escala

# set.seed(77)
amostra <- pareto_icdf(10000, a, b)

hist(amostra, 
     prob = TRUE,
     breaks = "FD",
     main = "Amostra Gerada vs. Densidade Teórica",
     xlab = "Valores da Amostra",
     ylab = "Densidade",
     col = "lightblue",
     border = "gray40",
     xlim = c(b, quantile(amostra, 0.95)),
     ylim = c(0, max(density(amostra)$y) * 1.2))

# Densidade teórica da Pareto(a, b)
curve((a * b^a) / (x^(a + 1)), 
      from = b, to = quantile(amostra, 0.95),
      add = TRUE, col = "red", lwd = 2)

legend("topright", 
       legend = c("Histograma da Amostra", "Densidade Teórica"),
       pch = c(22, NA),
       pt.bg = c("lightblue", NA),
       col = c("gray40", "red"),
       lty = c(NA, 1),
       lwd = c(NA, 2),
       pt.cex = 1.6,
       bty = "n",
       cex = 0.9)

mtext("Método da Transformada Inversa - Pareto(a = 2, b = 1)",
      side = 1, line = 4, cex = 0.9, font = 3)


```


## SIR Cauchy
```{r sir_cauchy}

cauchy_sir_t <- function(n, n_cand = n * 20, df_proposta = 0.5){
  
  # 1. Gerar candidatos da proposta t de Student
  x_cand <- rt(n_cand, df = df_proposta)
  
  # 2. Calcular a densidade alvo (Cauchy) numericamente via integral
  f <- sapply(x_cand, function(y)
    integrate(function(u) dnorm(u * y) * dnorm(u) * u,
              lower = 0, upper = Inf)$value
  )
  # 3. Calcular a densidade da proposta t de Student (g)
  g <- dt(x_cand, df = df_proposta)
  
  # 4. Calcular e normalizar os pesos
  w <- f / (g + 1e-10)
  w_norm <- w / sum(w)
  
  # 5. Reamostrar com base nos pesos
  indices <- sample(seq_len(n_cand), size = n, replace = TRUE, prob = w_norm)
  x_sir <- x_cand[indices]
  
  return(x_sir)
}

```

```{r graphic_cauchy}

# Gráfico para verificação

set.seed(63)
n_amostra <- 5000

amostra_gerada <- cauchy_sir_t(n = n_amostra, n_cand = 100000, df_proposta = 0.5)

# Dados do histograma para definir limites
dados_hist <- hist(amostra_gerada, breaks = 100, plot = FALSE)
altura_maxima <- max(dados_hist$density)

# --- Histograma com densidade teórica da Cauchy ---

hist(amostra_gerada, 
     prob = TRUE,
     breaks = "FD",
     main = "Amostra Gerada vs. Densidade Teórica (Cauchy)",
     xlab = "Valores da Amostra",
     ylab = "Densidade",
     col = "lightblue",
     border = "gray40",
     xlim = c(-15, 15),          
     ylim = c(0, 0.37))         

grid()

# --- Densidade teórica ---
grid_vals <- seq(-15, 15, length.out = 1000)
lines(grid_vals, dcauchy(grid_vals), col = "red", lwd = 2)

# --- Legenda em posição mais adequada ---
legend("right",
       legend = c("Histograma da Amostra", "Densidade Teórica (Cauchy)"),
       pch = c(22, NA),
       pt.bg = c("lightblue", NA),
       pt.cex = 1.5,
       col = c("gray40", "red"),
       lty = c(NA, 1),
       lwd = c(NA, 2),
       inset = c(0, -0.05),       
       xpd = TRUE,                
       bty = "n",
       cex = 0.9)

# --- Subtítulo descritivo ---
mtext("Método SIR com proposta t-Student (df = 1/2)", 
      side = 1, line = 4, cex = 0.9, font = 3)

```

## Simulação de Monte Carlo e Avaliação do Poder
```{r poder_mc}
poder_mc <- function(geradora, n, m = 1000, alpha = 0.05) {
  rejeita_sw <- rejeita_ad <- rejeita_jb <- rep(NA, m)
  
  for (i in 1:m) {
    x <- geradora(n)
    try({
      rejeita_sw[i] <- (shapiro.test(x)$p.value < alpha)
      rejeita_ad[i] <- (ad.test(x)$p.value < alpha)
      rejeita_jb[i] <- (jarque.bera.test(x)$p.value < alpha)
    }, silent = TRUE)
  }
  
  data.frame(
    Tamanho = n,
    `Poder.Shapiro.Wilk` = mean(rejeita_sw, na.rm = TRUE),
    `Poder.Anderson.Darling` = mean(rejeita_ad, na.rm = TRUE),
    `Poder.Jarque.Bera` = mean(rejeita_jb, na.rm = TRUE)
  )
}
```

# Tabela Referência
```{r estudo-erro-tipo1-vs-n, cache=TRUE}
sigma_fixed <- 1
sample_sizes <- c(10, 20, 30, 50)
M <- 1000 

results_list_tipo1_vs_n <- list()
for (n_val in sample_sizes) {
  
  normal_generator_fixo <- function(n) {
    rnorm(n, mean = 0, sd = sigma_fixed)
  }
  
  sim_result <- poder_mc(normal_generator_fixo, n = n_val, m = M)
  
  results_list_tipo1_vs_n[[length(results_list_tipo1_vs_n) + 1]] <- sim_result
}

results_tipo1_vs_n_df <- bind_rows(results_list_tipo1_vs_n)

table_data_tipo1_vs_n <- results_tipo1_vs_n_df %>%
  pivot_longer(
    cols = starts_with("Poder."),
    names_to = "Teste",
    values_to = "Erro_Tipo_I"
  ) %>%
  mutate(Teste = gsub("Poder.", "", Teste),
         Teste = gsub("_", "-", Teste)) %>%
  pivot_wider(
    names_from = Tamanho,
    values_from = Erro_Tipo_I
  )


tabela_erro_tipo1_vs_n <- table_data_tipo1_vs_n %>%
  gt() %>%
  
  tab_header(
    title = "Taxa Real de Erro do Tipo I por Tamanho de Amostra",
    subtitle = md(paste0("Desvio Padrão Fixo *σ* = ", sigma_fixed, ", Nível de significância nominal *α* = 0.05"))
  ) %>%
  
  cols_label(
    Teste = "Teste de Normalidade"
  ) %>%

  fmt_number(
    columns = everything(),
    decimals = 4
  ) %>%
  
  tab_spanner(
    label = "Tamanho da Amostra (n)",
    columns = everything()
  ) %>%

  tab_options(
    table.border.top.color = "black",
    heading.border.bottom.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.hlines.color = "lightgrey",
    table_body.border.bottom.color = "black"
  )

tabela_erro_tipo1_vs_n
```

# Cenários

## Execução da Simulação
```{r simulacao}

geradoras_list <- list(
  "Qui-Quadrado (df=2)" = function(n) chi_rejection(n),
  "Pareto (a=2, b=1)"   = function(n) pareto_icdf(n, a = 2, b = 1),
  "Cauchy"               = function(n) cauchy_sir_t(n = n) 
)

results_list <- list()

for (dist_name in names(geradoras_list)) {
  geradora_func <- geradoras_list[[dist_name]]
  
  for (n_sample in sample_sizes) {
    sim_result <- poder_mc(geradora_func, n = n_sample, m = M)
    sim_result$Distribution <- dist_name 
    
    results_list[[length(results_list) + 1]] <- sim_result
  }
}

results_df <- bind_rows(results_list)

results_long <- results_df %>%
  pivot_longer(
    cols = starts_with("Poder."),
    names_to = "Teste",
    values_to = "Poder"
  ) %>%
  mutate(Teste = gsub("Poder.", "", Teste),
         Teste = gsub("\\.", "-", Teste))
```


## Tabela de Resultados
```{r simulacao-tabela-artigo}
table_data <- results_df %>%
  filter(Tamanho %in% sample_sizes) %>%
  
  rename(
    n = Tamanho,
    Distribuição = Distribution,
    W = `Poder.Shapiro.Wilk`,
    A2 = `Poder.Anderson.Darling`,
    JB = `Poder.Jarque.Bera`
  ) %>%
  
  arrange(Distribuição, n) %>%
  mutate(max_power = pmax(W, A2, JB))

tabela_poder <- table_data %>%
  gt(groupname_col = "Distribuição") %>%
  
  cols_hide(columns = "max_power") %>%
  
  cols_label(
    n = "n",
    W = "W",
    A2 = html("A<sup>2</sup>"),
    JB = "JB"
  ) %>%
  
  tab_header(
    title = "Poder dos Testes de Normalidade",
    subtitle = "Valores estimados via Simulação de Monte Carlo (M = 1000)"
  ) %>%
  
  fmt_number(
    columns = c(W, A2, JB),
    decimals = 4
  ) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = W,
      rows = W == max_power
    )
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = A2,
      rows = A2 == max_power
    )
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = JB,
      rows = JB == max_power
    )
  ) %>%

  opt_table_font(font = "Arial") %>%
  tab_options(
    table.border.top.color = "black",
    heading.border.bottom.color = "black",
    table_body.hlines.color = "lightgrey",
    table_body.border.bottom.color = "black",
    source_notes.font.size = 12
  )
tabela_poder
```

```{r}

grafico_poder <- ggplot(results_long, 
                        aes(x = Tamanho, 
                            y = Poder, 
                            color = Teste, 
                            shape = Teste, 
                            group = Teste)) +
  
  geom_line(linewidth = 1.2) +
  geom_point(size = 3.5, stroke = 1) +
  
  facet_wrap(~ Distribution, ncol = 3, scales = "fixed") +
  
  labs(
    title = "Poder dos Testes de Normalidade por Cenário",
    subtitle = "Comparação entre Anderson-Darling, Jarque-Bera e Shapiro-Wilk",
    x = "Tamanho da Amostra (n)",
    y = "Poder Estimado (Taxa de Rejeição de H0)",
    color = "Teste de Normalidade",
    shape = "Teste de Normalidade"
  ) +
  
  scale_y_continuous(labels = percent_format(), limits = c(0, 1), expand = expansion(mult = c(0, 0.05))) +
  scale_x_continuous(breaks = sample_sizes) +
  
  scale_color_manual(values = c(
    "Anderson-Darling" = "firebrick",
    "Jarque-Bera" = "royalblue",
    "Shapiro-Wilk" = "springgreen3"
  )) +
  scale_shape_manual(values = c(16, 17, 15)) +
  
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray40"),
    strip.background = element_blank(),          
    strip.text = element_text(face = "bold", size = 12),
    panel.border = element_blank(),              
    panel.grid.major = element_line(color = "gray85", linewidth = 0.4),  
    panel.grid.minor = element_line(color = "gray90", linewidth = 0.2),  
    panel.spacing = unit(1, "lines"),
    plot.margin = margin(10, 10, 10, 10)
  )

print(grafico_poder)

```

